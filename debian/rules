#!/usr/bin/make -f
# -*- makefile -*-

package = xlnk-kernel-module
docdir  = debian/tmp/usr/share/doc/$(package)

ARCH           ?= arm
KERNEL_SRC_DIR ?= /lib/modules/$(shell uname -r)/build

clean:
	rm -f build
	-$(MAKE) clean
	rm -rf debian/tmp debian/*~ debian/files* debian/substvars

build:
	$(MAKE) all
	touch build

binary-indep: build

binary-arch: build
	rm -rf debian/tmp
	install -d debian/tmp/DEBIAN $(docdir)
	$(MAKE) prefix=$(CURDIR)/debian/tmp ARCH=$(ARCH) KERNEL_SRC_DIR=$(KERNEL_SRC_DIR) install
	cp -a debian/copyright      $(docdir)
	cp -a debian/changelog      $(docdir)/changelog.Debian
	cp -a ChangeLog             $(docdir)/changelog
	cd $(docdir) && gzip -9 changelog changelog.Debian
	# gzip -r9 debian/tmp/usr/share/man
	dpkg-gencontrol
	sed -i -e 's/^Architecture: .*$$/Architecture: armhf/g' debian/tmp/DEBIAN/control
	cp -a debian/postinst       debian/tmp/DEBIAN
	cp -a debian/prerm          debian/tmp/DEBIAN
	cp -a debian/postrm         debian/tmp/DEBIAN
	chown -R root:root debian/tmp
	chmod -$ u+w,go=rX debian/tmp
	dpkg-deb --build debian/tmp ..

binary: binary-indep binary-arch

